---
title: "Hacking Homelessness & PDF Prisons"
description: "How to extract data from PDFs (in this case, homelessness figures in London), alongside a showcase of algorithmic tesselation of geospatial polygons."
date: "2017-11-09"
tags: ["r", "gis", "pdf", "homelessness"]
---

```{r setup, include=FALSE}

# markdown setup
knitr::opts_chunk$set(cache=TRUE, echo = FALSE, warning = FALSE, message = FALSE, out.width = '100%', dpi = 180, dev = 'svg')

# load pkgs
library(plyr)
library(stringr)
library(tidyverse)
library(tabulizer)
library(geogrid)
library(sf)
library(magick)
library(scales)

```

Shout-out to the [Monday Morning Data Science](http://us16.campaign-archive2.com/home/?u=5ea551600fcdf84334e5aa6b0&id=26c0b7221a) mailout from John Hopkins. Making my way through this week's (#41) edition, I hit upon quite the eulogy concerning a new R package: 

> "The most compelling data visualization libraries Iâ€™ve seen in awhile...you have to see it to believe it"

You had me at compelling (I'm not sure *who* had me exactly, this was the only entry w/o a name attached to it `r emo::ji("thinking")`).

## Hex Democratization 

Enter [`geogrid`](https://github.com/jbaileyh/geogrid) and a solution to the perennial information communication problem of plotting polygons of different sizes, that's equal parts functional and beautiful. In the link above the author, Joseph Bailey, eloquently explains the motivations behind this package for automatic transformations of geospatial polygons into regular and hexagonal grids. In short, a grid system ensures a fairer representation of spatial data (while retaining geography) and an automated implementation means this is suitable to use in less commonly studied places. On both counts, this is a wicked example of building tools that democratize good data science. `r emo::ji("hands")`

Next, I just needed a good reason to wheel it out (aside from sharing with y'all).[^fullcode] 

## Full Metal Data

[Combined Homelessness and Information Network (CHAIN)](https://www.mungos.org/work-with-us/chain/) is the foremost project collecting data about homelessness in London. Gaining direct access to the database is strictly limited to those working directly with rough sleepers. However, CHAIN reports are published on the Greater London Authority's (GLA) [London Datastore](https://data.london.gov.uk/dataset/chain-reports). The full annual report does contain data on the spatial distribution of rough sleepers, but it's only available in PDF format. `r emo::ji("skull")`

```{r, out.width = "75%", fig.align = "center", echo=FALSE}
knitr::include_graphics("/img/2017-11-09-Hacking_Homelessness_and_PDF_Prisons/file_extensions.png")
```

This xkcd cartoon is in good humour, but there's a lot of truth in this - PDF's have risen to represent a kind of absolute truth, embodied by their relative impenetrability from outside influence (this includes pesky data scientists). This all-but-closed system becomes a big problem when we want to extract the 'open' data holed up inside. (Enter next R package to save the day, stage left).

## Introducing tabulizer AKA Governments, Lock Up Your PDFs

Actual footage of [`tabulizer](https://github.com/ropensci/tabulizer), an rOpenSci project dreamed up by Thomas Leeper, encountering impervious PDF #478:

```{r, out.width = "75%", fig.align = "center", echo=FALSE}
knitr::include_graphics("/img/2017-11-09-Hacking_Homelessness_and_PDF_Prisons/oreally.jpg")
```

As the [rOpenSci release](https://ropensci.org/blog/2017/04/18/tabulizer/) tells, `tabulizer` gives us R mortals the power of the [tabula-java library](https://github.com/tabulapdf/tabula-java) for extracting tables from PDF files (which, in turn, powers [Tabula](http://tabula.technology/), which you might have come across). You should dig in to that release blog (and associated GitHub repo) for the juicy inner workings, but I'll show it off very shortly.

I should say that I hit some snags trying to get this package fully operational (again, detailed in the package release), owing to the dependency on Java. I will just say that the help contained within the below links were able to get me on my way (as a Mac user) AND it was worth it:

- [Relinking Java & rJava](https://stackoverflow.com/questions/35179151/cannot-load-r-xlsx-package-on-mac-os-10-11/36045290)
- [rJava fix after OSX upgrade](https://stackoverflow.com/questions/30738974/rjava-load-error-in-rstudio-r-after-upgrading-to-osx-yosemite)
- [`tabulizer` issues page](https://github.com/ropensci/tabulizer/issues?utf8=%E2%9C%93&q=is%3Aissue)

## Where the Magic Happens

With new friends in tow, it's about to go down on this PDF. Here's an idea of what we're working with (Eeyore's sad at PDFs courtesy of [`magick`](https://cran.r-project.org/web/packages/magick/vignettes/intro.html), if you were wondering):

```{r screenshot, eval=FALSE}
# read screenshot and eeyore
scrn <- image_read('~/Documents/Github/ewenme/static/img/2017-11-09-Hacking_Homelessness_and_PDF_Prisons/report_scrn.png')
eeyore <- image_read('https://upload.wikimedia.org/wikipedia/en/7/70/Eeyore.gif')

# composing
scrn_eeyore <- image_scale(image_background(eeyore, "none"), "x150")
scrn_eeyore_fin <- image_composite(image_scale(scrn, "x400"), scrn_eeyore, offset = "+550+30")

image_write(scrn_eeyore_fin, path = "~/Documents/Github/ewenme/static/img/2017-11-09-Hacking_Homelessness_and_PDF_Prisons/eeyore.png", format = "png")
```

```{r, out.width = "75%", fig.align = "center", echo=FALSE}
knitr::include_graphics("/img/2017-11-09-Hacking_Homelessness_and_PDF_Prisons/eeyore.png")
```

To get the data in this table out of it's prison, we use `extract_tables()`:

```{r extract, echo=TRUE}
library(tabulizer)

homeless_spatial_tab <- extract_tables(file = "https://files.datapress.com/london/dataset/chain-reports/2017-06-30T09:03:07.84/Greater%20London%20full%202016-17.pdf", pages = 19)

```

We simply fed this two arguments - the file path of the report and the page number with our table of interest - and returned a list object of length one, containing a character matrix. The resultant object needs some light wrangling to get it just right:

```{r wrangle, echo=TRUE}
# specify table list item
homeless_spatial_tab <- homeless_spatial_tab[[1]]

# remove unneeded rows and cols
homeless_spatial_tab <- homeless_spatial_tab[c(-2, -15, -37), -6:-7]

# get col names
col_names <- homeless_spatial_tab[1, ]

# create dataframe
homeless_spatial_tab <- data.frame(homeless_spatial_tab[-1, ])

# set colnames
colnames(homeless_spatial_tab) <- col_names

# set col types
homeless_spatial_tab <- mutate_at(homeless_spatial_tab, c("2013/14", "2014/15", "2015/16", "2016/17"), as.character)
homeless_spatial_tab <- mutate_at(homeless_spatial_tab, c("2013/14", "2014/15", "2015/16", "2016/17"), as.numeric)

head(homeless_spatial_tab)
```

Eeyore is joyful at this sight, mark my words. How effortless was that? This data is ripe for mapping. Speaking of which...

## Bring in the Maps

Back to `geogrid` stuff. For starters, let's load in the shapefiles we need (note: the GitHub repo's example is actually on London, too, so I won't dwell on every similar detail):

```{r hex_load, echo=TRUE, results='hide'}
library(geogrid)

# get spatial polygons
input_file <- system.file('extdata', 'london_LA.json', package='geogrid')
original_shapes <- read_polygons(input_file)

# get polygon details
original_details <- calculate_grid(original_shapes)

```

In the case of spatial joins, I've found [`sf`] (https://github.com/r-spatial/sf)(simple features) incredibly intuitive and so I'll employ this tactic now to merge the distinct datasets together. I did notice some differences in the names given to certain London Boroughs (mainly the use of '&'/'and') which will need addressing as well.

```{r spatial_join, echo=TRUE}
# rename homeless data boroughs strings not matching geogrid shp
homeless_spatial_tab$Borough <- str_replace(homeless_spatial_tab$Borough, pattern = "Richmond",
                                            replacement = "Richmond upon Thames")
homeless_spatial_tab$Borough <- str_replace(homeless_spatial_tab$Borough, 
                                            pattern = "&",
                                            replacement = "and")

library(sf)

# turn geogrid shapefile into sf format
original_shapes_sf <- st_as_sf(original_shapes)

# join homeless data
original_shapes_sf <- left_join(original_shapes_sf, homeless_spatial_tab, by=c("NAME"="Borough"))

```

We're about ready to put plot to paper. First, let's take a look at a traditional, real space assignment of the area.

```{r traditional_map, echo=TRUE}
# get coords
coords <- original_shapes_sf %>%
  # find polygon centroids (sf points object)
  st_centroid %>%
  # extract the coordinates of these points as a matrix
  st_coordinates

# insert centroid long and lat fields as attributes of polygons
original_shapes_sf$long <- coords[,1]
original_shapes_sf$lat <- coords[,2]

# get percentage change from baseline
original_shapes_sf$pct_chg <- (original_shapes_sf$`2016/17` - original_shapes_sf$`2013/14`) / original_shapes_sf$`2013/14` * 100

# traditional map
ggplot(original_shapes_sf) +
  geom_sf(aes(fill = pct_chg)) +
  geom_text(aes(long, lat, label=str_sub(NAME, 1, 4)), 
            alpha = 0.75, size = 2.5, color = 'white') +
  coord_sf() +
  scale_fill_viridis_c() +
  theme_void()

```

The metric used here represents % change in 2016/17 rough sleepers compared to 2013/14. Barking is highest (14 up to 49), but the eye and mind may be more drawn to some of it's bigger neighbours (e.g. Havering). 

Algorithmic tessellation is used to generate possible grid layouts for the data (as explained in the GitHub repo - I'll just be demo-ing the hexes, but the same can be done with regular grids):

```{r seeds, results='hide'}
par(mfrow=c(2,3), mar = c(0,0,2,0))
for (i in 1:6){
new_cells <-  calculate_grid(original_shapes, 0.03, 'hexagonal', i)
plot(new_cells, main = paste("Seed",i, sep=" "))
}
```

I'm quite partial to #3. Maneuvering from real space geography to this grid involves an implementation of the [hungarian algorithm](https://github.com/RcppCore/rcpp-gallery/blob/gh-pages/src/2013-09-24-minimal-assignment.cpp). All you have to do is `calculate_cell_size()` with the grid (seed) of choice and `assign_polygons()` to the shapefile containing the original geography. From there, the steps to visualisation are identical to previous ones:

```{r hex_map, echo=TRUE, results='hide'}

new_cells_hex <-  calculate_grid(original_shapes, 0.03, 'hexagonal', 3)
resulthex <- assign_polygons(original_shapes, new_cells_hex)

# turn geogrid shapefile into sf format
resulthex_sf <- st_as_sf(resulthex)

# join homeless data
resulthex_sf <- left_join(resulthex_sf, homeless_spatial_tab, by=c("NAME"="Borough"))

# get coords
coords <- resulthex_sf %>%
  # find polygon centroids (sf points object)
  st_centroid %>%
  # extract the coordinates of these points as a matrix
  st_coordinates

# insert centroid long and lat fields as attributes of polygons
resulthex_sf$long <- coords[,1]
resulthex_sf$lat <- coords[,2]

# get percentage change from baseline
resulthex_sf$pct_chg <- (resulthex_sf$`2016/17`- resulthex_sf$`2013/14`) / resulthex_sf$`2013/14`

# hex plot
ggplot(resulthex_sf) +
  geom_sf( aes(fill = pct_chg)) +
  geom_text(aes(long, lat, label=str_sub(NAME, 1, 4)), size = 2.5, color = 'white') +
  scale_fill_viridis_c(labels = percent) +
  coord_sf() +
  labs(title="Where are homeless sightings becoming more frequent in London?",
       subtitle="People seen rough sleeping, % change 2013/14 to 2016/17 by borough",
       caption="@ewen_") +
  theme_void() +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(size = 12, face = "bold"), 
    plot.subtitle = element_text(size = 9),
    axis.ticks = element_blank(), 
    legend.direction = "vertical", 
    legend.position = "right",
    legend.title=element_blank(),
    plot.margin = margin(1, 1, 1, 1, 'cm'),
    legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm")
  ) 

```

From PDF prison to `r emo::ji("fire")` hex map with ease. May this inspire you to solve your own [#otherpeoplesdata](https://twitter.com/hashtag/otherpeoplesdata?src=hash) horror stories.

## On a More Serious Note

I also hope that the seriousness of the subject matter was not forgotten. The rise in homelessness sightings is really bad. A major reason why getting hold of this homelessness data was so difficult is that organisations like St Mungo's suffer from chronic under-funding, and so machine-readable data is understandably not their top priority. They are amazing so please consider [donating to them](https://www.mungos.org/get-involved/donate/) if you can, and others like them below:

- [The Salvation Army](https://www.salvationarmyappeals.org.uk/site/Donation2;jsessionid=00000000.app203a?idb=2000701064&df_id=2425&mfc_pref=T&2425.donation=form1&NONCE_TOKEN=DA7336ADD131AA3751E20B98219A74D7&utm_campaign=GRANT&utm_source=Google&utm_content=Phrase&utm_medium=PPC&gclsrc=aw.ds&utm_term=homeless&gclid=Cj0KCQiA84rQBRDCARIsAPO8RFzawzfPkv1IMLJYy1LxToJvUthor11u6VKSmGbx2xOuRyD3ssUNm2YaAv9jEALw_wcB)
- [Barnardo's](https://donate.barnardos.org.uk/?ref=112326&gclid=Cj0KCQiA84rQBRDCARIsAPO8RFz9vr7leNhxRGfSouzzwJ4eY55HBLGh5VAcyCNA7EctyTbM7UYmmrQaAotFEALw_wcB)
- [centre point](https://centrepoint.org.uk/donate/)

[^fullcode]: To keep the post concise I don't show all of the code, especially code that generates figures. But you can find the full code [here](https://github.com/rbind/ewenme/blob/master/content/blog/hacking-homelessness-pdf-prisons.Rmd).