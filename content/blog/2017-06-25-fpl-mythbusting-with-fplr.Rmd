---
title: "FPL mythbusting with fplr"
description: "Dissecting fantasy football falsehoods with my very first R package."
date: "2017-06-25"
tags: ["r", "fpl"]
slug: fpl-mythbusting
draft: no
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(cache=TRUE, echo = TRUE, warning = FALSE, message = FALSE, out.width = '100%', dpi = 180, echo = FALSE)

# devtools::install_github("ewenme/fplr")

library(tidyverse)
library(fplr)
library(ewenthemes)
library(ggalt)
library(forcats)
library(zoo)

# RData file for this script. Note that functions that created data are not evaluated in this rmd
load("../data/fpl_2017.rda")

chart_caption = "source: fantasy.premierleague.com | @ewen_"

```

I recently authored my first R package (and definitely have the bug, now). It would be remiss of me to continue without a quick PSA for anyone out there thinking about dabbling in the package game - below is a shout-out of the invaluable resources I found along the way that kept me nice and sane.

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">ease in <a href="https://t.co/NdRYGE1whA">https://t.co/NdRYGE1whA</a><br>more detail <a href="https://t.co/ypqotSAF46">https://t.co/ypqotSAF46</a><br>best practice <a href="https://t.co/qRMZDXBdfQ">https://t.co/qRMZDXBdfQ</a><br>travis ðŸ’€ <a href="https://t.co/dEvM3PWsVb">https://t.co/dEvM3PWsVb</a></p>&mdash; ewen (@ewen_) <a href="https://twitter.com/ewen_/status/872480326890795009">June 7, 2017</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

I set out on my package contribution journey by focusing on the development of something that I myself would find useful (that way, I could keep at least one user happy). Each year, I play an edition of a fantasy sports game called [Fantasy Premier League](https://fantasy.premierleague.com/) (FPL), the official fantasy football game of England's top football division. If you really want to know the in's and out's of FPL, there's a [section of the site](https://fantasy.premierleague.com/a/help) just for rules. 

> TL;DR: for 38 rounds (called 'gameweeks'), you pick a team of football players to do good things that score you points and help you finish as high up the leader-board as possible.[^definitions]

Introducing...[`fplr`](https://ewenme.github.io/fplr/) - a package for the intersection of FPL players / R users like me (I hope it's not just me) to explore the game's data. In the rest of this post, I test drive the package by examining some aspects of the game that the community has long debated on. I won't necessarily dispel/confirm all of these things here, but it's a taster of what kinds of analyses can be spun up quickly using `fplr`.

## The early season rat race

Many users emphasise the importance of a good start, claiming that it is more difficult to do well in the latter stages of the season without a solid foundation built early on. To illustrate this, lets look at the average shift in overall rank by gameweek in one of my mini-leagues (a smaller league amongst a peer group) as the season progresses i.e. how much does a users rank change from week-to-week (N.B. in the current package version, I haven't developed a function to help make this easier, yet. Soon come)?

```{r data grab, eval=FALSE}

#get mini league players
league <- data.frame()

  for (i in 1:15) {
    # get detailed data for users
    data <- jsonlite::read_json(paste0("https://fantasy.premierleague.com/drf/leagues-classic-standings/458675?phase=1&ls-page=", i, "&lePage=1"),
                            simplifyVector = TRUE)
    # append dataframe as item in list
    data <- data$standings$results
    league <- rbind(league, data)

  }

# create empty list to append gameweek-level data to
leagueDetailed <- list()

# loop through user ids
  for (i in league$entry) {
    # get detailed data for users
    data <- userPerformance(user_id = i)
    # append dataframe as item in list
    leagueDetailed[[i]] <- data

  }

# bind rows of loop, add lagged values
leagueDetailed <- bind_rows(leagueDetailed) %>%
  group_by(entry) %>%
  mutate(prev_rank = lag(overall_rank, n=1), rank_chg = overall_rank - prev_rank)
```

```{r rank changes}
# plot rank change by gameweek
leagueDetailed %>%
  group_by(event) %>%
  summarise(val=mean(abs(rank_chg), na.rm=TRUE)) %>%
  ggplot(aes(x=event, y=val, group=1)) +
  geom_line(colour="#3A013B") +
  geom_smooth(se=FALSE, colour="#00FF96") +
  scale_y_comma(limits = c(0, 500000), expand = c(0, 0)) +
  theme_ewen_ws() +
  labs(title="Mean Change in Rank across the Season",
       subtitle="Sample of (708) users taken from an FPL mini-leage",
       x="Gameweek no.", y="Overall rank change",
       caption=chart_caption)

```

The "elbow" in this chart comes at a similar time to when my rank began to level off, somewhat. You might have noticed the spike in the penultimate gameweek - in this instance, lots of players actually played twice (known as a "double gameweek" to insiders), meaning a greater opportunity for big swings in user rankings.

## Team value

Another factor perceived to be important in gaining a healthy position for high scores is that of team value. As football players in the game perform well (or not so well), their price actually changes as a function of market forces i.e. how many users are transferring them into/out of their team? By 'playing the market', users can build up the money at their disposal with which to build the best team. Therefore, perhaps we would expect someone's final team value to be a good predictor of their final rank (N.B. one outlier was removed from this plot - sometimes people chase the team value as a game in itself, incurring lots of points penalties that drastically affect their team's points total. This was one of those cases).

To show a fairer picture, I have attempted to remove 'dead' users i.e. users that have given up on the game, while their team continues to register scores. To eliminate these zombie teams, I chose to use transfers (bringing a player in for an existing squad player) as a proxy. It is fairly safe to assume that users remaining active until the season end are also making (at least some) transfers up until the end of the season, too. I'll consider users who made a transfer in one of the final three gameweeks as 'live'.

```{r team val}
leagueDetailed %>%
  filter(event %in% c(37, 38)) %>%
  group_by(entry) %>%
  filter(sum(event_transfers) > 0) %>%
  ungroup() %>%
  filter(event == 38) %>%
  mutate(value=value/10, bank=bank/10, total = value+bank) %>%
  filter(total <=110) %>%
  ggplot(aes(x=overall_rank, y=total)) +
  geom_point(colour="#3A013B") +
  geom_smooth(method = "lm", se=FALSE, colour="#00FF96") +
  scale_x_comma(limits = c(4500000, 0), trans="reverse") +
  theme_ewen_ws() +
  labs(title="Final Ranking vs. Team Value",
       subtitle="Sample of (364) 'active' users taken from an FPL mini-leage",
       x="Final rank", y="Total team value (millions)",
       caption=chart_caption)
```

There's a moderate positive correlation, but plenty of variation as well - as was the case in our outlier, it is possible that users may chase team value at the expense of their league performance. Still, we can say that there appears to be a relationship between retaining a high team value and ranking highly. 

## "Taking Hits"

While one free transfer is permitted each week, users can make additional transfers at a cost of 4 points each - known as "taking a hit". This is a frequently toiled upon decision by FPL users, who must decide whether making this move will return a greater number of points (considering the penalty) than sticking. Perhaps the frequency someone incurs hits can tell us something about performance (again, I've removed an outlier incurring a huge number of these).

```{r hits}
hits <- leagueDetailed %>%
  group_by(entry) %>%
  summarise(hits = sum(event_transfers_cost)/4)

leagueDetailed %>%
  filter(event %in% c(37, 38)) %>%
  group_by(entry) %>%
  filter(sum(event_transfers) > 0) %>%
  ungroup() %>%
  filter(event == 38) %>%
  mutate(value=value/10, bank=bank/10, total = value+bank) %>%
  left_join(hits, by="entry") %>%
  filter(total <=110 & hits <= 75) %>%
  ggplot(aes(x=overall_rank, y=hits)) +
  geom_point(colour="#3A013B") +
  geom_smooth(method = "lm", se=FALSE, colour="#00FF96") +
  scale_x_comma(limits = c(4500000, 0), trans="reverse") +
  theme_ewen_ws(axis = FALSE) +
  labs(title="Final Ranking vs. No. of Hits Taken",
       subtitle="Sample of (363) 'active' users taken from an FPL mini-leage",
       x="Final rank", y="No. of hits taken",
       caption=chart_caption)
```

It appears that taking hits has very little correlation with a user's rank. This would suggest that there are indeed good 'hits', as users are able to get a high rank while racking them up. At the same time, this illuminates other playing styles that can also bring success i.e. users who refrain from taking 'hits' are able to get as high rank as those that do. 

## Picking the bench

Every user talks about the time they left that weeks hot player on the bench (each gameweek, you must choose a starting 11 players - if they play, your back-up players, or 'bench', do not play and do not collect points). This often leads to disgruntled folk who hold dear the belief that some kind of FPL God is consistently against them. If we look at users' benches across the season, how much variation is there?

```{r bench}
bench_points <- leagueDetailed %>%
  group_by(entry) %>%
  summarise(bench_pts = sum(points_on_bench))

leagueDetailed %>%
  filter(event %in% c(37, 38)) %>%
  group_by(entry) %>%
  filter(sum(event_transfers) > 0) %>%
  ungroup() %>%
  filter(event == 38) %>%
  mutate(value=value/10, bank=bank/10, total = value+bank) %>%
  left_join(bench_points, by="entry") %>%
  filter(total <= 110) %>%
  ggplot(aes(x=bench_pts, ..count..)) +
  geom_density(fill="#3A013B") +
  theme_ewen_ws() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  labs(title="No. of Points Benched over the Season",
       subtitle="Sample of (364) 'active' users taken from an FPL mini-leage",
       x="Total no. of benched points", y="Count",
       caption=chart_caption)
```

What we see is close to a normal distribution. So, probably no FPL God's retribution. Most people benched somewhere in the region of 150-300 points over the course of a season, with an unlucky/lucky few coming in higher or lower respectively.

## Bandwagons

Another phenomenon, representing something of an FPL meta-game, is that of the "bandwagon". This refers to times when certain players put in particularly explosive performances, triggering big movements in the market (i.e. lots of people bringing them in, similar to a hot stock). When were the biggest transfer booms?

```{r bandwagons}
playersDetailed %>%
  group_by(player_id) %>%
  mutate(var=paste0(web_name, " (vs. ", lag(opponent_team), ")")) %>%
  ungroup() %>%
  arrange(desc(transfers_balance)) %>%
  filter(row_number()<=6 | row_number()>=n()-4) %>%
  distinct(web_name, round, .keep_all=TRUE) %>%
  ggplot(aes(x=reorder(var, transfers_balance), y=transfers_balance)) +
  geom_col(fill="#3A013B") +
  scale_y_comma() +
  coord_flip() +
  theme_ewen_ws(axis = FALSE, grid = FALSE) +
  labs(title="Transfer Booms & Busts",
       subtitle="The biggest net transfer swings of the season",
       x="Player", y="Net Transfers", caption = chart_caption)
```

Dele Alli had the biggest influx of transfers all season in gameweek 21, after a masterclass against Chelsea. Incidentally, both the 2nd (Ibrahimovic) and 3rd (Gundogan) highest net transfers followed games against West Brom. 

As for the biggest net losses, these mostly belonged to players of high ownership who suffered serious injuries/suspensions. The most interesting case is that of Diego Costa, who was the center of a media frenzy claiming a (real-life) transfer to China was imminent (this never materialized).

Of course, these absolute swings are largely governed by a player's initial ownership size and profile. We can look at percentage changes in ownership of players to consider those who had large *relative* shifts in selection. 

```{r bandwagon relative}
playersDetailed %>%
  group_by(player_id) %>%
  mutate(selected_chg = ((selected - lag(selected))/lag(selected)),
         var=paste0(web_name, " (vs. ", lag(opponent_team), ")")) %>%
  arrange(desc(selected_chg)) %>%
  filter(transfers_balance >= 50000 | transfers_balance <= -50000) %>%
  ungroup() %>%
  filter(!is.na(selected_chg)) %>%
  filter(row_number()<=6 | row_number()>=n()-4) %>%
  distinct(web_name, round, .keep_all=TRUE) %>%
  ggplot(aes(x=reorder(var, selected_chg), y=selected_chg)) +
  geom_col(fill="#3A013B") +
  scale_y_percent(limits = c(-5, 25)) +
  coord_flip() +
  theme_ewen_ws(axis = FALSE, grid = FALSE) +
  labs(title="Ownership Booms & Busts",
       subtitle="The biggest ownership (%) change of the season",
       x="Player", y="Net ownership change (%)", caption = chart_caption)
```

Here we see huge percentage increases in the ownership of Fer and Stuani after promising displays on the opening day of the season and second gameweek, respectively. It is often in the very early stages that users scramble for players, often after just a single good performance, as there are few data points to go by otherwise. Jesus and Gabbiadini were actually both new arrivals to the game in the mid-season transfer window (in January, clubs can buy additional players) who started well - again, in the absence of any long-term trend, users rushed to scoop up these players.

Of course, the % drop in ownership is naturally capped (ownership can only fall by 100%). Interestingly, just two games after Jesus' huge upswing in ownership, he gave us the biggest fall (**almost 90%** of owners dropped him)! If that's not Murphy's Law in full effect, I don't know what is.

## How often are the top players hot?

Come the end of the season, we check the top point-scoring players and yearn for what might've been if we'd snapped them up at the right time. How much love did the top (eight) overall point scorers actually get from FPL users over the season, and when?

```{r streaks, eval=FALSE}
# get players
players <- players()

# create empty list
playersDetailed <- list()

# loop through player ids
  for (i in players$id) {
    # get detailed data for players
    data <- playerDetailed(player_id = i)
    # append dataframe as item in list
    playersDetailed[[i]] <- data

  }

#select player metadata
players <- select(players, id, web_name, team_name, position)

# bind rows of loop, merge metadata
playersDetailed <- bind_rows(playersDetailed) %>%
  left_join(players, by=c("player_id"="id"))

# get top 8 point scorers
top8 <- playersDetailed %>%
  group_by(web_name, team_name, player_id, position) %>%
  summarise(points= sum(total_points)) %>%
  arrange(desc(points)) %>%
  ungroup() %>%
  top_n(8, wt=points)
```

```{r streaks two}
# chart the top 5
playersDetailed %>%
  filter(player_id %in% top8$player_id) %>%
  group_by(player_id) %>%
  # group_by(player_id) %>%
  # mutate(prev_price = lag(price, n=1), price_chg = price - prev_price) %>%
  ggplot(aes(x=round, y=transfers_balance)) +
  geom_line(colour="#3A013B") +
  scale_y_comma() +
  theme_ewen_ws() +
  labs(title="Net Transfers of Top Point Scoring Players",
       x="Gameweek", y="Net transfers", caption = chart_caption) +
  facet_wrap( ~ as_factor(web_name), nrow = 2, ncol = 4)

```

We see very different relationships between certain players and the transfer market. De Bruyne remains exceptionally stable in ownership after a couple of early season swings, while Kane's ownership is volatile throughout. Some of this will be determined by player availability (i.e. were they injured/suspended), but also by how much variation there is in their points-scoring. Do we see consistency in the performance level of these players? 

```{r streaks three}
playersDetailed %>%
  filter(player_id %in% top8$player_id) %>%
  group_by(player_id) %>%
  mutate(points.5 = rollmean(x = total_points, 5, align = "right", fill = NA)) %>%
  ggplot(aes(x=round, y=points.5)) +
  geom_line(colour="#3A013B") +
  scale_y_comma() +
  theme_ewen_ws() +
  labs(title="Average Points of Top Point Scoring Players",
       x="Gameweek", y="Points average (last 5 GWs)", caption = chart_caption) +
  facet_wrap( ~ as_factor(web_name), nrow = 2, ncol = 4)
  
```

By applying a moving average in the above chart (each data point is an average of the last five gameweeks), we can imagine performance in terms of season phases. For someone like De Bruyne, we notice that his peak performances came at the very start and end of the season, which perhaps explains the tepid market in the middle of the season. In a similar fashion, we can identify 'purple patches' of players, like Alli in the season middle. Much of FPL success can be determined by ensuring ownership of these players during such patches. 

## Wrap-up

I hope this illustrates some of the possibilities available with the `fplR` package. I had a lot of fun making it, and look forward to using it to better understand my FPL experience. Do share any interesting things you're able to do with it (or any things that go wrong with it...), and *try* to enjoy the new season. It's just a game...

[^definitions]: In this post I have referred to actual footballers as 'players', and players of the FPL game as 'users'.
[^data]: At current, the FPL site only keeps detailed data for the *current* season. Therefore, some of the data used in this analysis will likely be unavailable once the new FPL season begins. For access to all data used in this analysis, please go [here](https://github.com/rbind/ewenme/blob/master/content/data/).
[^fullcode]: To keep the post concise I don't show all of the code, especially code that generates figures. But you can find the full code [here](https://github.com/rbind/ewenme/blob/master/content/blog/fpl-mythbusting-with-fplr.Rmd).