---
title: '...xPoints?'
description: "Translating advanced player performance metrics into fantasy football points potential."
date: '2019-03-04'
slug: xPoints
tags: ["football", "fpl"]
draft: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE, echo = TRUE, out.width = '75%', dev = c('svg', 'png'), fig.align='center')
```

To anyone paying attention over the last couple of years, some "advanced" football metrics (or expected goals, at least) seem to have successfully navigated the five stages of ~~grief~~ haranguing from the media charged with upholding the "magic" of the game. Imagine peak Lawrenson and Hansen placed in this scene:

<blockquote class="twitter-tweet" data-lang="en-gb"><p lang="en" dir="ltr">The stats don&#39;t look great but <a href="https://twitter.com/jjenas8?ref_src=twsrc%5Etfw">@jjenas8</a> says Brighton will be fine. <a href="https://twitter.com/hashtag/motd2?src=hash&amp;ref_src=twsrc%5Etfw">#motd2</a> <a href="https://t.co/JrXglJEy96">pic.twitter.com/JrXglJEy96</a></p>&mdash; Match of the Day (@BBCMOTD) <a href="https://twitter.com/BBCMOTD/status/1094731648178913280?ref_src=twsrc%5Etfw">10 February 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

Back in August 2017, StatsBomb's Ted Knutson [predicted](https://statsbomb.com/2017/08/xg-is-on-tv-now-what/), among other things, that the relentless xG circus would:

> Create an entire new generation of highly educated fans and coaches who view the game itself in a more knowledgeable light.

[Fantasy Premier League](https://fantasy.premierleague.com/) (FPL) is the official fantasy football game of the [Premier League](https://en.wikipedia.org/wiki/Premier_League), with more than five million "managers" (plus many thousands of passive agressive workplace league rivalries) and counting. FPL managers, particularly those taking it seriously/semi-seriously, probably represent an early adopter population in Ted's above prophecy - fans with a vested interest in gaining competitive advantage. It definitely shows...Michael Caley [chatting to the FML FPL podcast](http://fmlfpl.libsyn.com/ep-161-fireside-chat-with-michael-caley) recently, for one.

I think there's some appetite around for this stuff. What's also interesting to me is that, as an application of metrics like expected goals (xG), fantasy football player evaluation is a far simpler optimisation problem than the real thing. Especially for attacking players, FPL player evaluation is predominantly about *individual goal contributions* (goals and assists) because they result in *points* (three for an assist, while grabbing a goal equals four or five points for midfielders and forwards respectively). Other contributions to general play can be glossed over for the most part, even the "pre-assist", hence why the original FPL valuation for N'Golo Kanté (£5.0m) was so much lower than Sadio Mané's (£9.5m) in the current (2018/19) season.

Therefore, a useful FPL evaluation of attacking players could be made using metrics that quantify activity at the very sharp end of attacking moves, namely a combination of:

- **xG:** How many goals should a player have scored on average, given the shots they took?
- **xA:** How many assists should a player have provided on average, given the passes they made?

These can subsequently be combined to form an **expected goals contributions** measure, and thus a shorthand for understanding which attacking FPL assets to consider. So, what's the hold-up?

## Some data helpers I made earlier

Turns out that getting at the data should be quite simple - I've already authored a pair of R packages ready for the job. 

Both can be installed from GitHub using another library, [remotes](https://github.com/r-lib/remotes):

```{r install, eval=FALSE}
remotes::install_github(c("ewenme/fplr", "ewenme/understatr"))
```

[fplr](https://ewenme.github.io/fplr/) helps get data on FPL players...

```{r get-fpl-data}
library(fplr)

fpl_data <- fpl_get_players()

fpl_data
```

...and [understatr](https://github.com/ewenme/understatr) can help fetch [understat](https://understat.com/) data.

```{r get-understat-data}
library(understatr)

# get EPL team data
epl_team_stats <- get_league_teams_stats(league_name = "EPL", year = 2018)

# get EPL player data
epl_player_stats <- purrr::map_dfr(unique(epl_team_stats$team_name), get_team_players_stats, year = 2018)

epl_player_stats
```

There isn't a common identifier for joining across datasets, so a bit of prep is required to help join the datasets (e.g. standardising team/player names). Names are annoying, so I missed off some recoding of non-descript (read: little minutes) attacking players. Sorry.

```{r data-cleaning, echo=FALSE}
library(dplyr)
library(stringr)

# club name disparities
club_aliases <- c("Manchester City"="Man City", "Manchester United"="Man Utd",
                  "Wolverhampton Wanderers"="Wolves", "Newcastle United"="Newcastle",
                  "Tottenham"="Spurs")

# replace club name aliases
epl_player_stats$team_name <- str_replace_all(epl_player_stats$team_name, pattern = club_aliases)

# create fpl web name equivalent
epl_player_stats$web_name <- sub(".*? (.+)", "\\1", epl_player_stats$player_name)

# fix known differences
epl_player_stats <- mutate(epl_player_stats, web_name = case_when(
  player_id == 617 ~ "David Silva",
  player_id == 3635 ~ "Bernardo Silva",
  player_id == 1208 ~ "Felipe Anderson",
  player_id == 453 ~ "Son",
  player_id == 3293 ~ "Lucas Moura",
  player_id == 7420 ~ "Almirón",
  player_id == 813 ~ "Rondón",
  player_id == 770 ~ "Pérez",
  player_id == 1663 ~ "Gudmundsson",
  player_id == 1700 ~ "Lucas",
  player_id == 2383 ~ "André Gomes",
  TRUE ~ web_name
  ))

```

Once that's down, the data can be merged and the attackers with reasonable minutes (at least 900) isolated. At the same time, we can put together the metrics of interest discussed above.

```{r data-merge}
# join understat/fpl data
player_stats <- left_join(
  select(fpl_data, id, web_name, status, now_cost, cost_change_start, 
         total_points, minutes, team_name, position), 
  select(epl_player_stats, -year, -yellow_cards:-position), 
  by = c("web_name", "team_name") 
  ) %>%
  # select midfielders/forwards w/ good mins
  filter(position %in% c("Midfielder", "Forward"), minutes >= 900, 
         status != "Unavailable") %>% 
  # metric calculations
  mutate_at(c("goals", "xG", "assists", "xA", "shots", "npg", "npxG"),
            list(`90` = ~(./minutes)*90)) %>% 
  mutate(xGA_90 = xG_90 + xA_90)

player_stats
```

Let's get some of these numbers on the board, already. (PS - the chart styles come courtesy of another personal pkg, [ewenthemes](https://github.com/ewenme/ewenthemes)).

```{r simple-xGA, out.width="100%", echo=FALSE}

library(ggplot2)
library(ewenthemes)
library(ggrepel)

ggplot(player_stats, aes(x = xG_90, y = xA_90)) +
  geom_point() +
  # add some labels (making sure to credit understat!)
  labs(title = "Expected goals contributions",
       x = "xG per 90", y = "xA per 90", caption = "source: understat.com | @ewen_") +
  # add my chart theme
  theme_ewen_ws(grid = FALSE) +
  geom_text_repel(aes(label = web_name), 
                  data = filter(player_stats, ntile(xG_90, 10) == 10 | ntile(xA_90, 10) == 10))

```


## Speaking different languages



- expressing expected goal contributions as points
- understanding value
- normalising for minutes
