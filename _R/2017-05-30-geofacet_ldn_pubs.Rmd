---
date: "2017-05-30"
title: "Exploring London's Pubs & Bars with geofacet"
author: "Ewen Henderson"
showonlyimage: false
draft: false
image: "blog/img/pub-map-uk-all-731587.jpg"
weight: 0
type: "post"
description: "A look at London's pubs and bars with the geofacet package."
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, out.width = 625,
                      cache = TRUE, cache.lazy = FALSE, dpi = 180)
options(width=120, dplyr.width = 150)

# devtools::install_github("hafen/geofacet")

```

## Introducing geofacet

The [`geofacet`](https://github.com/hafen/geofacet) package dropped recently (I want to say last week?), a `ggplot2` extension allowing for the user to facet plots in a way that can retain an underlying geographical dimension. It perhaps goes a little bit further towards abstraction than [tilegrams](https://pitchinteractiveinc.github.io/tilegrams/), but the visualizations we produce can be a bit more complex as well. This post documents my first foray into this packages functionality.

<br>

## Getting to grips with grids

If we think about faceting in `ggplot2` (`facet_wrap`, `facet_grid`), we are already familiar with the idea of placing a sequence of plots into a number of panels, arranged according to a variable(s) of interest.

`geofacet` is based on the assumption that we want to arrange our sequence of plots into a grid that preserves some known geographical orientation. These known geographical orientations are stored as **grids**, which provide us with row and column values corresponding to a panel's position in a faceted plot. Take this US states example, providing grid positions for US states:

```{r grid eg}
head(geofacet::us_state_grid1)
```

This grid also contains geographical data (state codes/names). We can simply join our data, that sits nicely within this geographical framework, to this grid and start 'geofaceting'.

There is a function in the package, `submit_grid`, which allows users to submit their own grids (as a dataframe, like in the above example) as a github issue and hopefully get them incorporated into the package proper. Having kicked off with just the US states, there's now grids for EU countries, South African provinces, Australian states and London boroughs. Nice - my business is with the latter...

<br>

## Geofaceting London

A couple of months ago, [a dataset was published](https://data.london.gov.uk/dataset/the-number-of-public-houses-and-bars-in-london-2001-2016) containing the number of public houses (pubs) and bars by local authority (borough) in London from 2001 through 2016. We'll use this to demonstrate how this package can help us visualize trends in data without losing the geography along the way.

Below is a map of London's boroughs, in case you aren't familiar.

![](http://www.resizr.com/resized/779b.png)

<br>

With that cleared up, let's load up this data and get it into shape.

```{r setup n load}

library(geofacet)
library(tidyverse)
library(gdata)
library(stringr)
library(viridis)
library(scales)
library(hrbrthemes)

#read/clean pubs data
pubs <- read.xls("http://files.datapress.com/london/dataset/the-number-of-public-houses-and-bars-in-london-2001-2016/2017-04-13T14:37:50.73/numberofpublichousesandbarsinlondon2001to2016.xls",
                 sheet = "Number of workplaces by LA", skip=2, stringsAsFactors=FALSE) %>%
  filter(!`X.1` %in% c("", "London")) %>%
  gather(key=year, value=count, -X, -`X.1`) %>%
  rename(code_ons=X, area_name=`X.1`) %>%
  mutate(count=as.numeric(count), year=as.numeric(str_replace(year, "X", ""))) %>%
  # add year-on-year pct change
  arrange(area_name) %>%
  group_by(area_name) %>%
  mutate(prev=lag(count, order_by=year, default=first(count)),
         yoy_chg=(count-prev)/prev)

glimpse(pubs)

```

So, we have a tidy dataframe with yearly counts and year-on-year change in pub numbers by borough. Let's peek at the existing `geofacet` grid for London boroughs.

```{r ldn grid}
glimpse(london_boroughs_grid)
```

We're ready to join these on the ONS code field. I'll also put in some line breaks to the borough names - I think some of these might be too long for a densely paneled plot, otherwise.

```{r join}
#clean boro strings in pubs df
pubs$area_name <- str_replace(pubs$area_name, " ", "\n")

#clean boro strings in geofacet grid df
london_boroughs_grid$name <- str_replace(london_boroughs_grid$name, " ", "\n")

# join pubs w/ grid
pubs <- inner_join(pubs, london_boroughs_grid, by ="code_ons") %>%
  select(-name)
```

Ready to plot. All we need to do is call `facet_geo` in the same way we might have faceted by borough using `facet_wrap` previously. This has to be accompanied by a `grid` argument, specifying the grid we want to facet with. We can go on to tweak the plot using familiar `ggplot2` commands.

Here's my first effort:

```{r geofacet, fig.width = 10, fig.height = 10}

# geofaceted plot of year-on-year pubs % change 
ggplot(data = pubs, aes(x=year, y=yoy_chg, fill=yoy_chg)) +
  geom_col() +
  geom_hline(yintercept = 0) +
  facet_geo( ~ area_name, grid = "london_boroughs_grid") +
  scale_x_continuous(breaks = c(2001, 2016), 
                     labels = NULL) +
  scale_y_percent(limits=c(-0.35,0.25), breaks=c(-0.3, 0, 0.25), labels = NULL) +
  labs(title = "The Evolution of London's Pubs & Bars",
       subtitle = "No. of Public Houses and Bars by London borough, 2001-2016",
       caption = "Source: data.london.gov.uk", x = "", y = "") +
  theme_minimal(base_family = "Arial Narrow", base_size = 14) +
  scale_fill_viridis(option="D",limits=c(-0.35,0.25), name="Year-on-year\n% change",
                     labels=percent) +
  theme(legend.position=c(.9, .95))

```

<br>

## Close

As the package author, [Ryan Hafen accepts](https://twitter.com/hafenstats/status/869621852385165312) that some of these plot's readability does rely on some pre-existing knowledge of the underlying geography (Ryan also says to watch out for some ideas to deal with this). Bearing this in mind, there are opportunities to make eye-catching plots on the occasions when this assumption holds (see [this New York Times example](https://www.nytimes.com/2017/05/25/opinion/sunday/the-assault-on-colleges-and-the-american-dream.html)). I reckon I'm gonna have fun with it...